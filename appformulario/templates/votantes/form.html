{% extends 'base.html' %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-lg-8"> 
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">

                <div class="text-center mb-5">
                    <h2 class="h3 fw-bold" style="color: var(--color-text);">
                        {{ titulo }}
                    </h2>
                    <p class="text-muted">
                        Complete la información del votante a continuación.
                    </p>
                </div>

                <form method="post">
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Errores del formulario:</strong>
                        <ul class="mt-2">
                            {% for field, errors in form.errors.items %}
                                <li><strong>{{ field }}:</strong> {{ errors.0 }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% csrf_token %}

                    <!-- ============================= -->
                    <!--   SECCIÓN 1: DATOS PERSONALES -->
                    <!-- ============================= -->
                    <h5 class="fw-bold mb-3 text-primary">Datos Personales</h5>

                    <div class="row">

                        <!-- ROL -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Rol</label>
                            {{ form.rol }}
                            {% if form.rol.errors %}
                                <div class="text-danger small">{{ form.rol.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- NOMBRES -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Nombres</label>
                            {{ form.nombre }}
                            {% if form.nombre.errors %}
                                <div class="text-danger small">{{ form.nombre.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- APELLIDOS -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Apellidos</label>
                            {{ form.apellido }}
                            {% if form.apellido.errors %}
                                <div class="text-danger small">{{ form.apellido.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- CÉDULA -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Cédula</label>
                            {{ form.cedula }}
                            {% if form.cedula.errors %}
                                <div class="text-danger small">{{ form.cedula.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- TELÉFONO -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Teléfono</label>
                            {{ form.telefono }}
                            {% if form.telefono.errors %}
                                <div class="text-danger small">{{ form.telefono.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- DIRECCIÓN -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Dirección</label>
                            {{ form.direccion_residencia }}
                            {% if form.direccion_residencia.errors %}
                                <div class="text-danger small">{{ form.direccion_residencia.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- BARRIO -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Barrio</label>
                            {{ form.barrio_residencia }}
                            {% if form.barrio_residencia.errors %}
                                <div class="text-danger small">{{ form.barrio_residencia.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- MUNICIPIO DE RESIDENCIA -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Municipio de residencia</label>
                            {{ form.municipio_residencia }}
                            {% if form.municipio_residencia.errors %}
                                <div class="text-danger small">{{ form.municipio_residencia.errors.0 }}</div>
                            {% endif %}
                        </div>

                    </div>

                    <hr class="my-4">

                    <!-- ============================= -->
                    <!--       SECCIÓN 2: LÍDER        -->
                    <!-- ============================= -->
                    <h5 class="fw-bold mb-3 text-primary">Líder</h5>

                    <div class="row">

                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Seleccione el líder</label>

                            <div class="input-group">
                                <select id="id_lider_asignado" name="lider_asignado" class="form-select">
                                    <option value="">Seleccione un líder</option>

                                    {% with selected=form.lider_asignado.value %}
                                        {% for lider in form.fields.lider_asignado.queryset %}
                                            <option 
                                                value="{{ lider.id }}"
                                                data-cedula="{{ lider.cedula }}"
                                                data-telefono="{{ lider.telefono }}"
                                                {% if selected|stringformat:"s" == lider.id|stringformat:"s" %}selected{% endif %}
                                            >
                                                {{ lider.nombre }} {{ lider.apellido }}
                                            </option>
                                        {% endfor %}
                                    {% endwith %}
                                </select>
                            </div>

                            {% if form.lider_asignado.errors %}
                                <div class="text-danger small mt-1">{{ form.lider_asignado.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Datos auto-rellenados -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Cédula del líder</label>
                            <input id="cedula_lider" class="form-control" readonly>
                        </div>

                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Teléfono del líder</label>
                            <input id="telefono_lider" class="form-control" readonly>
                        </div>

                    </div>

                    <hr class="my-4">

                    <!-- ============================= -->
                    <!--   SECCIÓN 3: PUESTO VOTACIÓN  -->
                    <!-- ============================= -->
                    <h5 class="fw-bold mb-3 text-primary">Puesto de Votación</h5>

                    <div class="row">

                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Puesto de votación</label>
                            <select id="id_puesto_votacion" name="puesto_votacion" class="form-select">
                                <option value="">Seleccione un puesto</option>

                                {% with selected=form.puesto_votacion.value %}
                                    {% for puesto in form.fields.puesto_votacion.queryset %}
                                        <option
                                            value="{{ puesto.id }}"
                                            data-direccion="{{ puesto.direccion }}"
                                            data-municipio="{{ puesto.municipio.nombre }}"
                                            data-departamento="{{ puesto.municipio.departamento.nombre }}"
                                            {% if selected|stringformat:"s" == puesto.id|stringformat:"s" %}selected{% endif %}
                                        >
                                            {{ puesto.nombre_lugar }}
                                        </option>
                                    {% endfor %}
                                {% endwith %}
                            </select>

                            {% if form.puesto_votacion.errors %}
                                <div class="text-danger small">{{ form.puesto_votacion.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Mesa -->
                        <div id="contenedor-mesa" class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Mesa</label>

                            {{ form.mesa }}

                            {% if form.mesa.errors %}
                                <div class="text-danger small">{{ form.mesa.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Datos auto-rellenados -->
                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Dirección</label>
                            <input id="direccion_puesto" class="form-control" readonly>
                        </div>

                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Municipio</label>
                            <input id="municipio" class="form-control" readonly>
                        </div>

                        <div class="mb-4 col-md-6">
                            <label class="form-label small fw-bold text-secondary">Departamento</label>
                            <input id="departamento" class="form-control" readonly>
                        </div>

                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-end align-items-center gap-3 mt-4 pt-3 border-top">
                        <a href="{% url 'lista_votantes' %}" class="btn btn-link text-decoration-none text-muted">Cancelar</a>
                        <button type="submit" class="btn btn-primary rounded-pill px-5 py-2 shadow-sm">Guardar Datos</button>
                    </div>

                </form>


            </div>
        </div>
    </div>
</div>

<!-- AUTORRELLENAR DATOS DEL LIDER (unificado) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectLider = document.getElementById("id_lider_asignado");
    const cedulaInput = document.getElementById("cedula_lider");
    const telefonoInput = document.getElementById("telefono_lider");

    function fillLiderFields() {
        const opt = selectLider.options[selectLider.selectedIndex];
        if (opt && opt.value) {
            cedulaInput.value = opt.dataset.cedula || "";
            telefonoInput.value = opt.dataset.telefono || "";
        } else {
            cedulaInput.value = "";
            telefonoInput.value = "";
        }
    }

    if (selectLider) {
        selectLider.addEventListener("change", fillLiderFields);
        // Rellenar al cargar en caso de edición
        fillLiderFields();
    }
});
</script>

<!-- JAVASCRIPT PARA CARGAR MESAS SEGÚN EL PUESTO -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const selectPuesto = document.getElementById("id_puesto_votacion");
    const selectMesa   = document.getElementById("id_mesa");

    // Obtener la mesa seleccionada al cargar el formulario (si estamos editando)
    const mesaSeleccionada = "{{ form.mesa.value|default:'' }}";

    // --- Función para cargar mesas ---
    function cargarMesas(puestoId) {

        if (!puestoId) {
            // No hay puesto → deshabilitar select de mesa
            selectMesa.innerHTML = "<option>Seleccione un puesto primero</option>";
            selectMesa.disabled = true;
            return;
        }

        // Cargar mesas vía AJAX
        fetch(`/personas/ajax/mesas/?puesto_id=${puestoId}`)
        .then(response => response.json())
        .then(data => {

            selectMesa.innerHTML = "";
            selectMesa.disabled = false; // Habilitar

            // Añadir opción vacía para que no quede ninguna seleccionada por defecto
            selectMesa.innerHTML = '<option value="">Seleccione una mesa</option>';

            data.mesas.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.id;
                opt.textContent = "Mesa " + m.numero;

                // Marcar mesa seleccionada al editar
                if (mesaSeleccionada == m.id) {
                    opt.selected = true;
                }

                selectMesa.appendChild(opt);
            });
        });
    }

    // --- Evento al cambiar puesto ---
    selectPuesto.addEventListener("change", function () {
        cargarMesas(this.value);
    });

    // --- Al cargar la página ---
    if (selectPuesto.value) {
        // Si estamos editando, cargar mesas y habilitar
        cargarMesas(selectPuesto.value);
    } else {
        // Si no hay puesto seleccionado → deshabilitar
        selectMesa.innerHTML = "<option>Seleccione un puesto primero</option>";
        selectMesa.disabled = true;
    }

});
</script>

<!-- AUTORRELLENAR DATOS DEL PUESTO -->
<script>
document.getElementById("id_puesto_votacion").addEventListener("change", function () {

    const option = this.options[this.selectedIndex];

    document.getElementById("direccion_puesto").value = option.dataset.direccion || "";
    document.getElementById("municipio").value        = option.dataset.municipio || "";
    document.getElementById("departamento").value     = option.dataset.departamento || "";
});
</script>

<!-- AUTORRELLENAR DATOS DEL PUESTO AL EDITAR -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const option = document.querySelector("#id_puesto_votacion option:checked");

    if (option) {
        document.getElementById("direccion_puesto").value = option.dataset.direccion || "";
        document.getElementById("municipio").value        = option.dataset.municipio || "";
        document.getElementById("departamento").value     = option.dataset.departamento || "";
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const leaderSelect = document.getElementById("id_lider_asignado"); // select de líderes
    const roleSelect   = document.getElementById("id_rol");          // select normal (si existe)
    const roleRadios   = document.querySelectorAll('input[name="rol"]'); // radioselect (si aplica)

    if (!leaderSelect) return; // si no existe, nada que hacer

    // Crear (o reutilizar) el contenedor del mensaje informativo
    let infoMsg = document.getElementById("lider-info-msg");
    if (!infoMsg) {
        infoMsg = document.createElement("div");
        infoMsg.id = "lider-info-msg";
        // Usamos una alerta pequeña de bootstrap y aria-live para accesibilidad
        infoMsg.className = "alert alert-info small py-1 mt-2";
        infoMsg.setAttribute("role", "status");
        infoMsg.setAttribute("aria-live", "polite");
        // Texto por defecto (se reemplaza dinámicamente)
        infoMsg.textContent = "";
        // Insertar después del select de líder (si hay un contenedor padre adecuado)
        leaderSelect.parentNode.insertBefore(infoMsg, leaderSelect.nextSibling);
    }

    function isRoleLeader(value) {
        if (!value) return false;
        return value.toString().toUpperCase().includes("LIDER");
    }

    function toggleLeaderSelect(isLeader) {
        if (isLeader) {
            // Deshabilitar y limpiar selección
            leaderSelect.disabled = true;
            leaderSelect.value = "";
            leaderSelect.selectedIndex = 0; // mostrar la opción por defecto

            // Mostrar mensaje informativo
            infoMsg.textContent = "Al seleccionar el rol «Líder», este votante no puede tener un líder asignado. El campo se ha deshabilitado automáticamente.";
            infoMsg.style.display = "block";
            leaderSelect.setAttribute("aria-disabled", "true");
            leaderSelect.classList.add("disabled");
        } else {
            // Habilitar y ocultar mensaje
            leaderSelect.disabled = false;
            infoMsg.style.display = "none";
            leaderSelect.removeAttribute("aria-disabled");
            leaderSelect.classList.remove("disabled");
        }
    }

    // Inicializar según el estado actual (caso edición)
    if (roleSelect) {
        toggleLeaderSelect(isRoleLeader(roleSelect.value));
        roleSelect.addEventListener("change", function () {
            toggleLeaderSelect(isRoleLeader(this.value));
        });
    }

    if (roleRadios && roleRadios.length) {
        // Ver cuál está marcado al cargar
        const checked = Array.from(roleRadios).find(r => r.checked);
        toggleLeaderSelect(isRoleLeader(checked ? checked.value : ""));

        roleRadios.forEach(radio => {
            radio.addEventListener("change", function () {
                toggleLeaderSelect(isRoleLeader(this.value));
            });
        });
    }
});
</script>


{% endblock %}
