{% extends 'base.html' %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<style>
    .form-control, .form-select { 
        border-color: #e9ecef; 
        font-size: 0.9rem; 
        padding: 0.5rem 0.75rem; 
    }

    .form-control:focus, .form-select:focus { 
        border-color: #198754; 
        box-shadow: none; 
    }

    .form-control[readonly] { 
        background-color: #f8f9fa !important; 
        border-color: #eee; 
        color: #6c757d; 
        cursor: not-allowed; /* Cursor prohibido para campos readonly */
    }

    /* Estilos para selects */
    select.form-select:not(:disabled) {
        cursor: pointer; /* Cursor de mano cuando se puede interactuar */
    }

    select.form-select:disabled {
        cursor: not-allowed; /* Cursor prohibido cuando está deshabilitado */
        background-color: #f8f9fa;
        color: #6c757d;
    }

    /* Campos de líder (Cédula y Teléfono) */
    #cedula_lider, #telefono_lider {
        cursor: not-allowed;
        background-color: #f8f9fa;
        color: #6c757d;
    }

    .card { border-radius: 12px; }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">

                <div class="text-center mb-4">
                    <h2 class="h4 fw-bold" style="color: var(--color-text);">{{ titulo }}</h2>
                    <p class="text-muted small">Complete la información del votante a continuación.</p>
                </div>

                <form method="post">
                    {% if form.errors %}
                    <div class="alert alert-danger py-2">
                        <ul class="mb-0 small">
                            {% for field, errors in form.errors.items %}
                                <li><strong>{{ field }}:</strong> {{ errors.0 }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% csrf_token %}

                    <div class="d-flex align-items-center mb-3">
                        <h6 class="fw-bold mb-0 text-success text-uppercase" style="letter-spacing: 1px;">Datos Personales</h6>
                        <div class="flex-grow-1 ms-3 border-bottom opacity-25"></div>
                    </div>

                    <div class="row g-3">

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Departamento de Residencia</label>
                            {{ form.departamento_residencia }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Municipio de Residencia</label>
                            <select id="id_municipio_residencia" name="municipio_residencia" class="form-select" disabled>
                                <option value="">---</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Corregimiento de Residencia</label>
                            <select id="id_corregimiento_residencia" name="corregimiento_residencia" class="form-select" disabled>
                                <option value="">---</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-secondary mb-1">Nombres</label>
                            {{ form.nombre }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-secondary mb-1">Apellidos</label>
                            {{ form.apellido }}
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Cargo / Función</label>
                            {{ form.rol }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Cédula</label>
                            {{ form.cedula }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Teléfono</label>
                            {{ form.telefono }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Barrio</label>
                            {{ form.barrio_residencia }}
                        </div>

                        <div class="col-12">
                            <label class="form-label small fw-bold text-secondary mb-1">Dirección</label>
                            {{ form.direccion_residencia }}
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-3 mt-4">
                        <h6 class="fw-bold mb-0 text-success text-uppercase" style="letter-spacing: 1px;">Asignación de Líder</h6>
                        <div class="flex-grow-1 ms-3 border-bottom opacity-25"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-secondary mb-1">Líder responsable</label>
                            <select id="id_lider_asignado" name="lider_asignado" class="form-select">
                                <option value="">Sin líder asignado</option>
                                {% with selected=form.lider_asignado.value %}
                                    {% for lider in form.fields.lider_asignado.queryset %}
                                        <option value="{{ lider.id }}" data-cedula="{{ lider.cedula }}" data-telefono="{{ lider.telefono }}"
                                            {% if selected|stringformat:"s" == lider.id|stringformat:"s" %}selected{% endif %}>
                                            {{ lider.nombre }} {{ lider.apellido }}
                                        </option>
                                    {% endfor %}
                                {% endwith %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Cédula del Líder</label>
                            <input id="cedula_lider" class="form-control bg-light" readonly tabindex="-1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Teléfono del Líder</label>
                            <input id="telefono_lider" class="form-control bg-light" readonly tabindex="-1">
                        </div>
                    </div>

                    <div class="d-flex align-items-center mb-3 mt-4">
                        <h6 class="fw-bold mb-0 text-success text-uppercase" style="letter-spacing: 1px;">Lugar de Votación</h6>
                        <div class="flex-grow-1 ms-3 border-bottom opacity-25"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Departamento del Puesto</label>
                            <select id="id_dept_puesto_filtro" class="form-select">
                                <option value="">Seleccione...</option>
                                {% for dept in form.fields.departamento_residencia.queryset %}
                                    <option value="{{ dept.id }}" {% if form.instance.puesto_votacion and form.instance.puesto_votacion.municipio.departamento.id == dept.id %}selected{% endif %}>
                                        {{ dept.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Municipio del Puesto</label>
                            <select id="id_muni_puesto_filtro" class="form-select" disabled>
                                <option value="">---</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-secondary mb-1">Corregimiento del Puesto</label>
                            <select id="id_corre_puesto_filtro" class="form-select" disabled>
                                <option value="">---</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label small fw-bold text-secondary mb-1">Puesto de Votación</label>
                            <select id="id_puesto_votacion" name="puesto_votacion" class="form-select" disabled>
                                <option value="">Seleccione una ubicación</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-secondary mb-1">Mesa</label>
                            <select id="id_mesa" name="mesa" class="form-select" disabled>
                                <option value="">---</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end align-items-center gap-3 mt-5 pt-3 border-top">
                        <a href="{% url 'lista_votantes' %}" class="btn btn-link text-decoration-none text-muted small">Cancelar</a>
                        <button type="submit" class="btn btn-success px-5 shadow-sm fw-bold">Guardar Registro</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select { border-color: #e9ecef; font-size: 0.9rem; padding: 0.5rem 0.75rem; }
    .form-control:focus, .form-select:focus { border-color: #198754; box-shadow: none; }
    .form-control[readonly] { background-color: #f8f9fa !important; border-color: #eee; color: #6c757d; }
    .card { border-radius: 12px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // --- SELECTORES ---
    const fDeptPuesto = document.getElementById("id_dept_puesto_filtro");
    const fMuniPuesto = document.getElementById("id_muni_puesto_filtro");
    const fCorrePuesto = document.getElementById("id_corre_puesto_filtro");
    const selectPuesto = document.getElementById("id_puesto_votacion");
    const selectMesa = document.getElementById("id_mesa");

    const selectDeptRes = document.getElementById("id_departamento_residencia");
    const selectMuniRes = document.getElementById("id_municipio_residencia");
    const selectCorrRes = document.getElementById("id_corregimiento_residencia");

    const selectLider = document.getElementById("id_lider_asignado");
    const cedulaInput = document.getElementById("cedula_lider");
    const telefonoInput = document.getElementById("telefono_lider");
    const roleSelect = document.querySelector("[name='rol']");

    // --- VALORES INICIALES (PARA EDICIÓN) ---
    const initMuniResId = "{{ form.municipio_residencia.value|default:'' }}";
    const initCorrResId = "{{ form.corregimiento_residencia.value|default:'' }}";
    
    const initPuestoId = "{{ form.puesto_votacion.value|default:'' }}";
    const initMesaId   = "{{ form.mesa.value|default:'' }}";
    const initMuniPuestoId = "{% if form.instance.puesto_votacion %}{{ form.instance.puesto_votacion.municipio.id }}{% endif %}";
    const initCorrePuestoId = "{% if form.instance.puesto_votacion %}{{ form.instance.puesto_votacion.corregimiento.id|default:'' }}{% endif %}";

    function resetSelect(el, text, disabled = true) {
        if (!el) return;
        el.innerHTML = `<option value="">${text}</option>`;
        el.disabled = disabled;
    }

    // ==========================================
    // 1. LÓGICA LÍDER (MENSAJE, BLOQUEO Y AUTO-RELLENO)
    // ==========================================
    function fillLiderFields() {
        if (!selectLider) return;
        const opt = selectLider.options[selectLider.selectedIndex];
        cedulaInput.value = (opt && opt.value) ? (opt.dataset.cedula || "") : "";
        telefonoInput.value = (opt && opt.value) ? (opt.dataset.telefono || "") : "";
    }

    if (selectLider && roleSelect) {
        let infoMsg = document.getElementById("lider-info-msg");
        if (!infoMsg) {
            infoMsg = document.createElement("div");
            infoMsg.id = "lider-info-msg";
            infoMsg.className = "alert alert-warning small py-1 mt-1 mb-0";
            infoMsg.style.display = "none";
            infoMsg.textContent = "Un Líder no puede tener otro líder asignado.";
            selectLider.parentNode.appendChild(infoMsg);
        }

        function toggleLeaderSelect(val) {
            const isLeader = val.toString().toUpperCase().includes("LIDER");
            if (isLeader) {
                selectLider.disabled = true;
                selectLider.value = "";
                fillLiderFields();
                infoMsg.style.display = "block";
            } else {
                selectLider.disabled = false;
                infoMsg.style.display = "none";
            }
        }

        roleSelect.addEventListener("change", (e) => toggleLeaderSelect(e.target.value));
        selectLider.addEventListener("change", fillLiderFields);
        
        // Ejecución inicial
        toggleLeaderSelect(roleSelect.value);
        setTimeout(fillLiderFields, 200);
    }

    // ==========================================
    // 2. LÓGICA RESIDENCIA (SECUENCIAL)
    // ==========================================
    if (selectDeptRes) {
        selectDeptRes.addEventListener("change", function() {
            resetSelect(selectMuniRes, "Cargando...");
            resetSelect(selectCorrRes, "---", true);
            if (!this.value) return;
            fetch(`/personas/ajax/municipios/?departamento_id=${this.value}`)
                .then(res => res.json())
                .then(data => {
                    resetSelect(selectMuniRes, "Seleccione Municipio", false);
                    data.municipios.forEach(m => selectMuniRes.add(new Option(m.nombre, m.id)));
                    if (initMuniResId) {
                        selectMuniRes.value = initMuniResId;
                        selectMuniRes.dispatchEvent(new Event('change'));
                    }
                });
        });
    }

    if (selectMuniRes) {
        selectMuniRes.addEventListener("change", function() {
            resetSelect(selectCorrRes, "Cargando...");
            if (!this.value) return;
            fetch(`/personas/ajax/corregimientos/?municipio_id=${this.value}`)
                .then(res => res.json())
                .then(data => {
                    resetSelect(selectCorrRes, "Seleccione (SOLO SI APLICA)", false);
                    data.corregimientos.forEach(c => selectCorrRes.add(new Option(c.nombre, c.id)));
                    if (initCorrResId) selectCorrRes.value = initCorrResId;
                });
        });
    }

    // ==========================================
    // 3. LÓGICA PUESTO DE VOTACIÓN (SECUENCIAL)
    // ==========================================
    fDeptPuesto.addEventListener("change", function() {
        resetSelect(fMuniPuesto, "Cargando...");
        resetSelect(fCorrePuesto, "---", true);
        resetSelect(selectPuesto, "---", true);
        if (!this.value) return;
        fetch(`/personas/ajax/municipios/?departamento_id=${this.value}`)
            .then(res => res.json())
            .then(data => {
                resetSelect(fMuniPuesto, "Seleccione Municipio", false);
                data.municipios.forEach(m => fMuniPuesto.add(new Option(m.nombre, m.id)));
                if (initMuniPuestoId) {
                    fMuniPuesto.value = initMuniPuestoId;
                    fMuniPuesto.dispatchEvent(new Event('change'));
                }
            });
    });

    fMuniPuesto.addEventListener("change", function() {
        resetSelect(fCorrePuesto, "Cargando...");
        resetSelect(selectPuesto, "Cargando...", true);
        if (!this.value) return;
        fetch(`/personas/ajax/corregimientos/?municipio_id=${this.value}`)
            .then(res => res.json())
            .then(data => {
                resetSelect(fCorrePuesto, "Seleccione (SOLO SI APLICA)", false);
                data.corregimientos.forEach(c => fCorrePuesto.add(new Option(c.nombre, c.id)));
                if (initCorrePuestoId) fCorrePuesto.value = initCorrePuestoId;
            });
        cargarPuestos(this.value, fCorrePuesto.value);
    });

    fCorrePuesto.addEventListener("change", () => cargarPuestos(fMuniPuesto.value, fCorrePuesto.value));

    function cargarPuestos(muniId, correId) {
        resetSelect(selectPuesto, "Cargando...");
        let url = `/personas/ajax/puestos/?municipio_id=${muniId}`;
        if (correId) url += `&corregimiento_id=${correId}`;
        fetch(url).then(res => res.json()).then(data => {
            resetSelect(selectPuesto, "Seleccione Puesto", false);
            data.puestos.forEach(p => {
                const opt = new Option(p.nombre, p.id);
                if (p.id == initPuestoId) opt.selected = true;
                selectPuesto.add(opt);
            });
            if (selectPuesto.value) selectPuesto.dispatchEvent(new Event('change'));
        });
    }

    selectPuesto.addEventListener("change", function() {
        if (this.value) cargarMesas(this.value);
        else resetSelect(selectMesa, "---", true);
    });

    function cargarMesas(puestoId) {
        resetSelect(selectMesa, "Cargando...");
        fetch(`/personas/ajax/mesas/?puesto_id=${puestoId}`)
            .then(res => res.json())
            .then(data => {
                resetSelect(selectMesa, "Seleccione Mesa", false);
                data.mesas.forEach(m => {
                    const opt = new Option("Mesa " + m.numero, m.id);
                    if (m.id == initMesaId) opt.selected = true;
                    selectMesa.add(opt);
                });
            });
    }

    // --- DISPARO INICIAL (EDICIÓN) ---
    if (selectDeptRes && selectDeptRes.value) selectDeptRes.dispatchEvent(new Event('change'));
    if (fDeptPuesto && fDeptPuesto.value) fDeptPuesto.dispatchEvent(new Event('change'));

});
</script>
{% endblock %}